<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
       xmlns:context="http://www.springframework.org/schema/context"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                           http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
                           http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd">

    <context:property-placeholder location="classpath:application.properties" order="5" ignore-unresolvable="true" />
    <!-- Client side -->

    <int:gateway id="gw"
                 service-interface="com.safeway.app.iass.emcl.gateway.EmclGateway"
                 default-request-channel="input"/>

    <!-- Create a connection for the client gateway that uses the same Stx-Etx deserializer to turn the stream
    into the appropriate content (it looks for the Stx byte, extracts anything between it and the Etx byte). We
    don't specify the serializer (although we could) because the unit test explicitly shows how the content
    to be sent is wrapped by the Stx and Etx bytes. -->
    <int-ip:tcp-connection-factory id="client"
                                   type="client"
                                   host="${emcl.server.hostname}"
                                   port="${emcl.server.port}"
                                   single-use="true"
                                   so-timeout="${emcl.client.connection.so-timeout}"
                                   so-keep-alive="true"
                                   deserializer="customT1Deserializer"/>

    <int:channel id="input"/>

    <bean id="cachingConnectionFactory"
          class="org.springframework.integration.ip.tcp.connection.CachingClientConnectionFactory">
        <constructor-arg ref="client"/>
        <constructor-arg value="${emcl.client.connection.poolsize}"/>
        <property name="connectionWaitTimeout" value="${emcl.client.connection.connectionWaitTimeout}"/>
    </bean>

    <int-ip:tcp-outbound-gateway id="outGateway"
                                 request-channel="input"
                                 reply-channel="clientBytes2StringChannel"
                                 connection-factory="cachingConnectionFactory"
                                 request-timeout="${emcl.client.connection.request-timeout}"
                                 reply-timeout="${emcl.client.connection.reply-timeout}"/>

    <int:channel id="clientBytes2StringChannel"/>

    <int:object-to-string-transformer id="clientBytes2String"
                                      input-channel="clientBytes2StringChannel"/>


</beans>